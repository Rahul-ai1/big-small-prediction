<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Big/Small Prediction Game</title>
  <link rel="icon" href="icon.png" />
  <link rel="apple-touch-icon" href="icon.png" />
  <meta name="theme-color" content="#121212" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Big/Small Game" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      --bg-dark: #121212;
      --text-dark: #ffffff;
      --button-bg-dark: #333;
      --button-text-dark: #fff;

      --bg-light: #f5f5f5;
      --text-light: #000000;
      --button-bg-light: #ddd;
      --button-text-light: #000;
    }

    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: var(--bg-dark);
      color: var(--text-dark);
      transition: background-color 0.3s ease, color 0.3s ease;
      margin: 0;
      padding: 0 20px 40px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    body.light {
      background-color: var(--bg-light);
      color: var(--text-light);
    }
    h1 {
      font-size: 2rem;
      margin: 20px 0 10px;
    }

    #splash {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-dark);
      color: var(--text-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      z-index: 9999;
      user-select: none;
    }
    body.light #splash {
      background: var(--bg-light);
      color: var(--text-light);
    }

    button {
      padding: 10px 20px;
      margin: 10px 5px;
      font-size: 1rem;
      cursor: pointer;
      background-color: var(--button-bg-dark);
      color: var(--button-text-dark);
      border: none;
      border-radius: 5px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    body.light button {
      background-color: var(--button-bg-light);
      color: var(--button-text-light);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #toggleThemeBtn {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 10000;
    }

    #welcome {
      font-size: 1.2rem;
      margin-top: 10px;
      min-height: 30px;
    }

    #namePrompt {
      margin: 15px 0;
    }
    #namePrompt input {
      padding: 6px 10px;
      font-size: 1rem;
      width: 200px;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-right: 8px;
    }

    #scoreboard, #coins {
      margin: 10px 0;
      font-size: 1.2rem;
      font-weight: bold;
    }

    #result {
      margin: 20px 0;
      font-size: 1.5rem;
      min-height: 40px;
      font-weight: bold;
    }

    #countdown {
      font-size: 1.2rem;
      color: #ccc;
      margin-top: 10px;
      user-select: none;
    }

    .prediction-buttons {
      margin-top: 20px;
    }

  </style>
</head>
<body>
  <!-- Splash screen -->
  <div id="splash">üîÆ Big/Small Prediction Game Loading...</div>

  <!-- Theme toggle -->
  <button id="toggleThemeBtn" aria-label="Toggle Theme">üåó Toggle Theme</button>

  <!-- User greeting -->
  <div id="welcome"></div>

  <!-- Name input prompt -->
  <div id="namePrompt" style="display:none;">
    <p>Please enter your name:</p>
    <input id="nameInput" placeholder="Your name" autocomplete="off" />
    <button id="saveNameBtn">Save</button>
  </div>

  <!-- Score and coins -->
  <div id="coins">üí∞ Coins: 100</div>
  <div id="scoreboard">üèÜ Score: 0</div>

  <!-- Prediction buttons -->
  <div class="prediction-buttons">
    <button id="btnSmall">Small (0-4)</button>
    <button id="btnBig">Big (5-9)</button>
  </div>

  <!-- Result display -->
  <div id="result"></div>

  <!-- Countdown timer -->
  <div id="countdown">Next round in: <span id="timer">20</span> seconds</div>

  <script>
    // Splash screen hide after 1 second on load
    window.onload = () => {
      setTimeout(() => {
        document.getElementById('splash').style.display = 'none';
      }, 1000);
    };

    // Theme toggle logic
    const toggleBtn = document.getElementById('toggleThemeBtn');
    const body = document.body;
    const savedTheme = localStorage.getItem('theme') || 'dark';
    if(savedTheme === 'light') body.classList.add('light');
    else body.classList.remove('light');

    toggleBtn.addEventListener('click', () => {
      body.classList.toggle('light');
      const isLight = body.classList.contains('light');
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
    });

    // User data and game state
    let userName = localStorage.getItem('userName') || null;
    let userCoins = parseInt(localStorage.getItem('userCoins')) || 100;
    let userScore = parseInt(localStorage.getItem('userScore')) || 0;
    let prediction = null;
    let countdown = 20;
    let timerInterval = null;

    // UI elements
    const welcomeEl = document.getElementById('welcome');
    const namePromptEl = document.getElementById('namePrompt');
    const nameInputEl = document.getElementById('nameInput');
    const saveNameBtn = document.getElementById('saveNameBtn');
    const coinsEl = document.getElementById('coins');
    const scoreEl = document.getElementById('scoreboard');
    const resultEl = document.getElementById('result');
    const timerEl = document.getElementById('timer');
    const btnSmall = document.getElementById('btnSmall');
    const btnBig = document.getElementById('btnBig');

    // Initialize UI
    function updateUI() {
      coinsEl.textContent = `üí∞ Coins: ${userCoins}`;
      scoreEl.textContent = `üèÜ Score: ${userScore}`;
      if (userName) {
        welcomeEl.innerHTML = `üëã Welcome, <strong>${userName}</strong>!`;
        namePromptEl.style.display = 'none';
      } else {
        welcomeEl.textContent = '';
        namePromptEl.style.display = 'block';
      }
      // Disable prediction buttons if not enough coins
      const canPlay = userCoins >= 10;
      btnSmall.disabled = !canPlay;
      btnBig.disabled = !canPlay;
    }

    saveNameBtn.addEventListener('click', () => {
      const val = nameInputEl.value.trim();
      if (val) {
        userName = val;
        localStorage.setItem('userName', userName);
        updateUI();
      } else {
        alert("Please enter a valid name.");
      }
    });

    // Save progress to localStorage
    function saveProgress() {
      localStorage.setItem('userCoins', userCoins);
      localStorage.setItem('userScore', userScore);
    }

    // Prediction button handlers
    btnSmall.addEventListener('click', () => makePrediction('small'));
    btnBig.addEventListener('click', () => makePrediction('big'));

    function makePrediction(choice) {
      if (userCoins < 10) {
        alert("You don't have enough coins to bet!");
        return;
      }
      prediction = choice;
      resultEl.textContent = `You picked ${choice.toUpperCase()}. Waiting for result...`;
    }

    // Fetch Ethereum block hash and get last digit for randomness
    async function fetchLastDigitFromHash() {
      try {
        const response = await fetch('https://api.blockcypher.com/v1/eth/main');
        const data = await response.json();
        const hash = data.hash;
        // Take last digit as hex, convert to decimal, mod 10 to get 0-9
        const lastDigit = parseInt(hash.slice(-1), 16) % 10;
        return lastDigit;
      } catch (error) {
        // Fallback: random 0-9
        return Math.floor(Math.random() * 10);
      }
    }

    // Run the game round
    async function runGame() {
      if (!prediction) {
        resultEl.textContent = "Please make a prediction first!";
        return;
      }
      if (userCoins < 10) {
        alert("You don't have enough coins to bet!");
        return;
      }

      const lastDigit = await fetchLastDigitFromHash();
      const outcome = lastDigit <= 4 ? 'small' : 'big';

      if (prediction === outcome) {
        userScore++;
        userCoins += 10;
        resultEl.textContent = `üéâ You WON! Number was ${lastDigit} (${outcome.toUpperCase()})`;
      } else {
        userCoins = Math.max(0, userCoins - 10);
        resultEl.textContent = `‚ùå You LOST! Number was ${lastDigit} (${outcome.toUpperCase()})`;
      }

      prediction = null;
      updateUI();
      saveProgress();

      if (userCoins === 0) {
        alert("You are out of coins! Please refresh the page to restart.");
        // Disable buttons as no coins left
        btnSmall.disabled = true;
        btnBig.disabled = true;
      }
    }

    // Countdown timer for auto run every 20 seconds
    function startTimer() {
      countdown = 20;
      timerEl.textContent = countdown;
      if (timerInterval) clearInterval(timerInterval);

      timerInterval = setInterval(async () => {
        countdown--;
        timerEl.textContent = countdown;

        if (countdown <= 0) {
          countdown = 20;
          timerEl.textContent = countdown;
          // Auto run only if prediction made
          if (prediction) {
            await runGame();
          } else {
            resultEl.textContent = "Time's up! Please make a prediction.";
          }
        }
      }, 1000);
    }

    // Initial UI setup
    updateUI();
    startTimer();

  </script>
</body>
</html>
